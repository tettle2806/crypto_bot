sequenceDiagram
    actor User as Пользователь
    participant UI as Веб/Мобильный Интерфейс
    participant API as API Gateway
    participant Auth as Аутентификация
    participant Algo as AlgoTrading Service
    participant Events as Events Service
    participant Market as Market Analysis Service
    participant DB as База данных
    participant Exchange as Биржа

    %% Регистрация и настройка
    User->>UI: Регистрация/Авторизация
    UI->>API: Отправка учетных данных
    API->>Auth: Проверка учетных данных
    Auth->>DB: Создание/Проверка пользователя
    DB-->>Auth: Подтверждение
    Auth-->>API: Выдача JWT токена
    API-->>UI: Возврат токена авторизации
    UI-->>User: Успешная авторизация

    %% Настройка подключения к бирже
    User->>UI: Добавление API ключей биржи
    UI->>API: Передача API ключей
    API->>Auth: Проверка авторизации
    Auth-->>API: Подтверждение
    API->>DB: Сохранение зашифрованных ключей
    DB-->>API: Подтверждение
    API-->>UI: Успешное сохранение
    UI-->>User: Подтверждение подключения к бирже

    %% Создание и настройка стратегии
    User->>UI: Создание торговой стратегии
    UI->>API: Параметры стратегии
    API->>Algo: Передача параметров
    Algo->>DB: Сохранение стратегии
    DB-->>Algo: Подтверждение
    Algo-->>API: Стратегия создана
    API-->>UI: Подтверждение
    UI-->>User: Стратегия сохранена

    %% Бэктестирование
    User->>UI: Запуск бэктеста стратегии
    UI->>API: Параметры бэктеста
    API->>Algo: Запрос на бэктест
    Algo->>Market: Запрос исторических данных
    Market->>DB: Получение данных
    DB-->>Market: Исторические данные
    Market-->>Algo: Данные для бэктеста
    Algo->>Algo: Выполнение бэктеста
    Algo->>DB: Сохранение результатов
    DB-->>Algo: Подтверждение
    Algo-->>API: Результаты бэктеста
    API-->>UI: Показ результатов
    UI-->>User: Отображение анализа бэктеста

    %% Запуск стратегии
    User->>UI: Запуск торговой стратегии
    UI->>API: Команда на запуск
    API->>Algo: Активация стратегии
    Algo->>DB: Обновление статуса
    DB-->>Algo: Подтверждение
    Algo->>Events: Регистрация событий мониторинга
    Events-->>Algo: Подтверждение
    Algo-->>API: Стратегия запущена
    API-->>UI: Подтверждение запуска
    UI-->>User: Стратегия активна

    %% Цикл торговли
    loop Торговый цикл
        Algo->>Market: Запрос рыночных данных
        Market->>Exchange: Получение текущих котировок
        Exchange-->>Market: Рыночные данные
        Market->>DB: Сохранение данных
        DB-->>Market: Подтверждение
        Market-->>Algo: Обработанные данные

        Algo->>Algo: Анализ данных
        Algo->>Algo: Применение стратегии
        
        alt Условия для сделки выполнены
            Algo->>Exchange: Размещение ордера
            Exchange-->>Algo: Подтверждение ордера
            Algo->>DB: Сохранение ордера
            DB-->>Algo: Подтверждение
            Algo->>Events: Создание уведомления
            Events->>DB: Сохранение уведомления
            DB-->>Events: Подтверждение
            Events-->>UI: Push-уведомление
            UI-->>User: Оповещение о сделке
        end
    end

    %% Мониторинг и отчетность
    User->>UI: Запрос статистики
    UI->>API: Запрос данных
    API->>Market: Запрос аналитики
    Market->>DB: Получение торговых данных
    DB-->>Market: Данные по сделкам
    Market->>Market: Формирование отчета
    Market-->>API: Аналитический отчет
    API-->>UI: Передача отчета
    UI-->>User: Отображение статистики и графиков

    %% Настройка оповещений
    User->>UI: Настройка оповещений
    UI->>API: Параметры оповещений
    API->>Events: Создание правил оповещений
    Events->>DB: Сохранение правил
    DB-->>Events: Подтверждение
    Events-->>API: Оповещения настроены
    API-->>UI: Подтверждение
    UI-->>User: Оповещения активированы

    %% Остановка торговли
    User->>UI: Остановка стратегии
    UI->>API: Команда на остановку
    API->>Algo: Деактивация стратегии
    Algo->>Exchange: Отмена активных ордеров
    Exchange-->>Algo: Подтверждение отмены
    Algo->>DB: Обновление статуса
    DB-->>Algo: Подтверждение
    Algo->>Events: Отмена событий мониторинга
    Events-->>Algo: Подтверждение
    Algo-->>API: Стратегия остановлена
    API-->>UI: Подтверждение остановки
    UI-->>User: Стратегия деактивирована
